<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>UPC VISION</title>
<!-- plugins:css -->
<link rel="stylesheet"
	href="vendors/iconfonts/mdi/css/materialdesignicons.min.css">
<link rel="stylesheet"
	href="vendors/iconfonts/puse-icons-feather/feather.css">
<link rel="stylesheet"
	href="vendors/iconfonts/simple-line-icon/css/simple-line-icons.css">

<link rel="stylesheet" href="css/jquery.datetimepicker.css">
<link rel="stylesheet" href="css/c3.css">
<link rel="stylesheet" href="css/jquery.contextMenu.css">
<!-- 
<link rel="stylesheet" href="vendors/css/vendor.bundle.base.css">
<link rel="stylesheet" href="vendors/css/vendor.bundle.addons.css">
 -->
<link rel="stylesheet" href="css/style.css">
<link rel="shortcut icon" href="images/favicon.png" />

<!-- plugin css for this page -->
<link rel="stylesheet"
	href="vendors/iconfonts/font-awesome/css/font-awesome.min.css" />
<!-- plugin css for this page -->
<!-- End plugin css for this page -->

<!-- End plugin css for this page -->
<!-- inject:css -->
<link rel="stylesheet" href="css/style.css">
<!-- endinject -->
<script src="js/jquery-3.4.1.js"></script>
<script src="js/jquery.contextMenu.js"></script>
<script src="js/bootstrap-datetimepicker.min.js"></script>
<script src="js/sockjs.min.js"></script>
<script src="js/stomp.min.js"></script>
<script src="js/c3.js"></script>
<script src="js/d3.js"></script>
<!-- 这是个集成好的综合包，但是版本有点低，有些功能还没有实现，所以需要把匹配的新版本的包整理出来。
<script src="vendors/js/vendor.bundle.base.js"></script>
<script src="vendors/js/vendor.bundle.addons.js"></script>
 -->
<!-- 这部分是SVG操作的第三方库，基于Angular 
<script src="js/hammer.min.js"></script>
<script src="js/uniwheel.js"></script>
<script src="js/control-icons.js"></script>
<script src="js/utilities.js"></script>
<script src="js/svg-utilities.js"></script>
<script src="js/shadow-viewport.js"></script>
<script src="js/svg-pan-zoom.js"></script>
 -->

<script src="js/app.js"></script>
<script src="js/router.js"></script>
<script src="js/navagator.js"></script>
<script src="js/lodash.js"></script>

<style>

.overlay {
  fill: none;
  pointer-events: all;
}
button {
  padding: 10px 20px;
}

</style>
<body>

<div id="svgt">
</div>
<button id="zoom_in">+</button>
<button id="zoom_out">-</button>
<button id="zoom_fullScreen">[]</button>
<button id="zoom_left"><</button>
<button id="zoom_right">></button>
<button id="zoom_up">^</button>
<button id="zoom_down">!</button>
<button id="zoom_test">test</button>
<script>
$("#svgt").load("ltgrh101.svg", null, changeAAction);
var width = 960,
    height = 500;

var randomX = d3.random.normal(width / 2, 80),
    randomY = d3.random.normal(height / 2, 80);

// 页面加载完成后调用。在之前调用会导致不能正确获得对象。
function changeAAction() {
		  console.log("=====================");
	var d = document.getElementById("_diagramShow");
	//	  console.log("html:"+d.innerHTML);

	// 获取图形宽高
	svg1 = document.getElementsByTagName("svg");
	svg1 = svg1[0];
    width = svg1.attributes.width.value;
    height = svg1.attributes.height.value;
    //width = 960;
    //height = 500;
    console.log("widthaaa="+width+" heightbbb="+height+"");
    // D3操作对象
	zoom = d3.behavior.zoom().scaleExtent([0.5, 8]).on("zoom", zoomed); //= d3.zoom().scaleExtent([1, 8]).on("zoom", zoomed);
	svg = d3.select("svg").call(zoom);
	//svg = d3.select("#svg_101");
    //width = svg.attributes.width.value;
    //height = svg.attributes.height.value;
	
    console.log("svg => "+JSON.stringify(svg));
    console.log("=====2");
    // 对SVG内的的所有button设置点击事件为zoomClick缩放操作。
	//d3.selectAll('button').on('click', zoomClick);	
    // svg.selectAll("g").call(d3.drag().on("drag", dragged));
    //console.log("00");
    //var drag = d3.drag();
	//svg.enter().attr("r", 2.5).attr("transform", function(d) { return "translate(" + d + ")"; });
    //console.log("11");
    //svg.selectAll("g").call(d3.drag().on("drag", dragged));
    zoom = d3.behavior.zoom().scaleExtent([0.5, 8]).on("zoom", zoomed);
    // 图形全屏
	fullScreenFn();

}

var svg1;
var svg ;//svg = document.getElementsByTagName("svg");
console.log("=====1");
var width = 0;//svg.attributes.width.value;
var height = 0;//svg.attributes.height.value;

var zoom;// = d3.behavior.zoom().scaleExtent([0.5, 8]).on("zoom", zoomed);
// zoom.scaleExtent([0.5, 8]);
//var _zoom = {"scale":1,"translate":[0,0]};
function zoomed() {
console.log("zoomed() zoom.translate()="+zoom.translate()+" zoom.scale()="+zoom.scale());

svg.attr("transform",
    "translate(" + zoom.translate() + ")" +
    //"translate(0,0)" +
    "scale(" + zoom.scale() + ")"
);
 // svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

function interpolateZoom (translate, scale) {

zoom
.scale(scale)
.translate(translate);
//_zoom.scale = iScale(t);
//_zoom.translate = iTranslate(t);
zoomed();

}

function zoomClick() {
var clicked = d3.event.target,
    direction = 1,
    factor = 0.2,
    target_zoom = 1,
    center = [width / 2, height / 2],
    extent = zoom.scaleExtent(),
    translate = zoom.translate(),
    translate0 = [],
    l = [],
    view = {x: translate[0], y: translate[1], k: zoom.scale()};

 d3.event.preventDefault();
	zoom.scaleExtent([0.5, 8]);

switch(this.id){
case 'zoom_up':
	console.log("=================== zoom_up");
	interpolateZoom([view.x, view.y-10], view.k)
	return;
case 'zoom_down':
	interpolateZoom([view.x, view.y+10], view.k)
	return;
case 'zoom_left':
	interpolateZoom([view.x-10, view.y], view.k)
	return;
case 'zoom_right':
	interpolateZoom([view.x+10, view.y], view.k)
	return;
case 'zoom_fullScreen':
	fullScreen();
	return;
case 'zoom_in':
	direction = 1;
	break;
case 'zoom_out':
	direction = -1;
	break;
case 'zoom_test':
	zoom.scale(zoom.scale() * 0.2);
	console.log("zoom.scale() -> "+zoom.scale());
	console.log("zoom.scaleExtent() -> "+zoom.scaleExtent());
	return;
default:
	return;
}
// direction = (this.id === 'zoom_in') ? 1 : -1;
target_zoom = zoom.scale() * (1 + factor * direction);

// if (target_zoom < extent[0] || target_zoom > extent[1]) { return false; }

translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
view.k = target_zoom;
l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

//view.x += center[0] - l[0];
//view.y += center[1] - l[1];
view.x += l[0] - center[0];
view.y += l[1] - center[1];

interpolateZoom([view.x, view.y], view.k);
//interpolateZoom([0, 0], view.k);
}

var fullScreenEnable = true;
function fullScreen(){
	console.log("fullScreen()");
	if(!fullScreenEnable)
		fullScreenEnable = !fullScreenEnable;
	fullScreenFn();
}

function fullScreenFn(){
	if(fullScreenEnable){
		// 取当前页面宽度和高度
		var _svgP = svg1.parentNode;
		var mainToolsBarRect = _svgP.getBoundingClientRect();
		//console.log(" y="+JSON.stringify(mainToolsBar.getBoundingClientRect()));
		// 取当前图形宽度和高度 
		console.log(" width="+width +" heigth="+height);
		// mainPanel屏幕左上角坐标
		var y = mainToolsBarRect.y ;//+ mainToolsBarRect.height;
		var x = mainToolsBarRect.x;
		var mainPanelHeigth = window.innerHeight;
		var mainPanelWidth = mainToolsBarRect.width;
		
		var scale1 = mainPanelHeigth / mainPanelWidth;
		var _diagramShow = document.getElementById("svgt").getBoundingClientRect();
		var scale2 = _diagramShow.height / _diagramShow.width;
		var scale ;//= scale1 > scale2 ? scale1 : scale2;
		if(scale1 > scale2){ // 图比屏幕扁，以图的宽为限
			scale = mainPanelWidth / width ;
		} else{
			scale = mainPanelHeigth / height;
		}
		
		console.log(" _diagramShow="+JSON.stringify(_diagramShow));
		console.log("window.innerHeight="+window.innerHeight);
		//console.log("document.documentElement.clientHeight = "+document.documentElement.clientHeight);
		//console.log("document.body.clientHeight = "+document.body.clientHeight);
		
		// 计算translate和scale,调用 function interpolateZoom (translate, scale)
		var tx = _diagramShow.x + _diagramShow.width/2 * (1 - scale);
		var ty = _diagramShow.y + _diagramShow.height/2 * (1 - scale);
		//var trans = {_diagramShow.x - x,_diagramShow.y - y};
		console.log("scale="+scale+" tx="+tx+" ty="+ty+" x="+x+" y="+y+" x-ty="+(x-tx)+" y-ty="+(y-ty));
        zoom
           .scale(scale)
           .translate([x- tx + 10, y- ty]);

		svg.attr("transform",
	            "translate(" + [x- tx + 10, y- ty] + ")" +
	            "scale(" + scale + ")"
	        );


		//interpolateZoom([x- tx, y- ty], scale);
		
		// 计算缩放比
//var _y={"x":266,"y":1,"width":840,"height":58,"top":1,"right":1106,"bottom":59,"left":266}
//width=1062 heigth=669
//_diagramShow={"x":285.390625,"y":76,"width":801.21875,"height":674,"top":76,"right":1086.609375,"bottom":750,"left":285.390625}			
		// 计算左上角坐标
		
		// 移动缩放图形
		
	}
}

$(window).resize(function(){
	fullScreenFn();
});

// 设置resize事件
addResizeEvent(fullScreenFn);
function addResizeEvent(func) {
    //把现有的 window.onload 事件处理函数的值存入变量
    var oldResize = window.resize;
    if (typeof window.resize != "function") {
      //如果这个处理函数还没有绑定任何函数，就像平时那样添加新函数
      window.onload = func;
    } else {
      //如果处理函数已经绑定了一些函数，就把新函数添加到末尾
      window.resize = function() {
    	  oldResize();
        func();
      }
    }
  }

d3.selectAll('button').on('click', zoomClick);


//********************* 对话框拖拽 ********
var mouseX = 0;
var mouseY = 0;
var Dragging = function(validateHandler) { //参数为验证点击区域是否为可移动区域，如果是返回欲移动元素，负责返回null
	var draggingObj = null; //dragging Dialog
	var diffX = 0;
	var diffY = 0;

	function mouseHandler(e) {
		switch (e.type) {
		case 'mousedown':
			console.log("mousedown");
			draggingObj = validateHandler(e);//验证是否为可点击移动区域
			if (draggingObj != null) {
				diffX = e.clientX - draggingObj.offsetLeft;
				diffY = e.clientY - draggingObj.offsetTop;
			}
			break;

		case 'mousemove':
			//console.log("e.clientX="+e.clientX+" e.clientY="+e.clientY);
			mouseX = e.clientX;
			mouseY = e.clientY;
			if (draggingObj) {
				draggingObj.style.left = (e.clientX - diffX) + 'px';
				draggingObj.style.top = (e.clientY - diffY) + 'px';
			}
			break;

		case 'mouseup':
			draggingObj = null;
			diffX = 0;
			diffY = 0;
			break;
		}
	}
	;

	return {
		enable : function() {
			document.addEventListener('mousedown', mouseHandler);
			document.addEventListener('mousemove', mouseHandler);
			document.addEventListener('mouseup', mouseHandler);
		},
		disable : function() {
			document.removeEventListener('mousedown', mouseHandler);
			document.removeEventListener('mousemove', mouseHandler);
			document.removeEventListener('mouseup', mouseHandler);
		}
	}
}

function getDraggingDialog(e) {
	var target = e.target;
	console.log(" 1 ->"+target);
	console.log(" 2 ->"+target.nodeName);
	console.log(" 3 ->"+target.nodeType + " " + target);
	console.log(" 4 ->"+target.getAttribute("id"));
	if (target.nodeName != "DIV")
		return;
	while (target && (target.className.indexOf('dialog-title') || target.getAttribute("id")=="toMenu" )== -1) {
		target = target.offsetParent;
	}
	if (target != null) {
		return target.offsetParent;
	} else {
		return null;
	}
}

Dragging(getDraggingDialog).enable();


function _addPointToXY(tagName) {
	var pointsul = document.getElementById("xygraph_points_ui");
	var pointli = document.createElement("li");
	pointli.setAttribute("id", "pointli_" + tagName);
	var lihtml = "";
	lihtml += '<div class="form-check form-check-flat"><label class="form-check-label">';
	lihtml += ' <input class="checkbox" type="checkbox">' + tagName;
	lihtml += '</label></div> ';
	lihtml += '<i class="remove mdi mdi-close-circle-outline" onclick="_removePointFromXY(\''
			+ tagName + '\')"></i>';
	pointli.innerHTML = lihtml;
	pointsul.appendChild(pointli);

	//addPointToXYGraph(tagName);
}
function _removePointFromXY(tagName) {
	var pointsul = document.getElementById("pointli_" + tagName);
	pointsul.parentNode.removeChild(pointsul);
	removePointFromXYGraph(tagName);
}



function zoomClick1() {
    var clicked = d3.event.target,
        direction = 1,
        factor = 0.2,
        target_zoom = 1,
        center = [width / 2, height / 2],
        extent = zoom.scaleExtent(),
        translate = zoom.translate(),
        translate0 = [],
        l = [],
        view = {x: translate[0], y: translate[1], k: zoom.scale()};
    console.log(" view= "+JSON.stringify(view)+ " ");

    console.log("================ zoomClick");
    d3.event.preventDefault();
    switch(this.id){
    case 'zoom_up':
    	console.log("=================== zoom_up");
    	interpolateZoom([view.x, view.y-10], view.k)
    	return;
    case 'zoom_down':
    	interpolateZoom([view.x, view.y+10], view.k)
    	return;
    case 'zoom_left':
    	interpolateZoom([view.x-10, view.y], view.k)
    	return;
    case 'zoom_right':
    	interpolateZoom([view.x+10, view.y], view.k)
    	return;
    case '':
    	fullScreen();
    	return;
    }
    console.log("zoomClick========+++++ ========");
    direction = (this.id === 'zoom_in') ? 1 : -1;
    // 缩放目标
    target_zoom = d3.scale * (1 + factor * direction);

    //if (target_zoom < extent[0] || target_zoom > extent[1]) { return false; }

    translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
    view.k = target_zoom;
    l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];
	// 向左上伸展
    //view.x += center[0] - l[0];
    //view.y += center[1] - l[1];
    // interpolateZoom([view.x, view.y], view.k);
    // interpolateZoom([0, 0], view.k); // 中心不动向四周伸展
    view.x += l[0] - center[0];
    view.y += l[1] - center[1];
    console.log(" view= "+JSON.stringify(view)+ " ");
    interpolateZoom([view.x, view.y], view.k); // 左上角不动，击右下伸展。
}

</script>